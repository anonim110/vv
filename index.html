<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web-мессенджер на Firestore</title>
    <!-- Подключение Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Использование шрифта Inter -->
    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Стилизация полосы прокрутки для Webkit */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #3B82F6; /* Синий цвет */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1F2937; /* Темный цвет */
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen overflow-hidden">

    <div id="app" class="flex h-full">
        <!-- Загрузочный экран -->
        <div id="loading-screen" class="absolute inset-0 bg-gray-900 flex items-center justify-center z-50">
            <div class="text-center">
                <div id="loading-spinner" class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mx-auto"></div>
                <p id="loading-message" class="mt-4 text-lg">Подключение к сервисам...</p>
            </div>
        </div>

        <!-- Левая панель (Sidebar) -->
        <div id="sidebar" class="w-full md:w-1/3 lg:w-1/4 bg-gray-800 border-r border-gray-700 flex flex-col hidden">
            <div class="p-4 border-b border-gray-700">
                <h2 class="text-xl font-bold text-white mb-1 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-blue-400"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    Мессенджер
                </h2>
                <div class="text-sm text-gray-400 truncate">Ваш ID: <span id="user-id-display" class="font-mono text-blue-300 select-all"></span></div>
            </div>

            <!-- Ввод нового чата -->
            <div class="p-4 bg-gray-900">
                <div id="chat-error" class="p-2 mb-2 text-sm font-medium text-red-100 bg-red-600 rounded-lg transition duration-300 hidden"></div>
                <input
                    type="text"
                    id="recipient-id-input"
                    placeholder="ID друга для чата..."
                    class="w-full p-2 mb-2 bg-gray-700 text-white rounded-lg focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400"
                />
                <button
                    id="start-chat-button"
                    class="w-full p-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition duration-150"
                >
                    <div class='flex items-center justify-center'>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        Начать Чат
                    </div>
                </button>
            </div>

            <!-- Список контактов -->
            <div class="flex-grow overflow-y-auto">
                <div class="p-4 text-gray-400 font-semibold uppercase text-xs tracking-wider">
                    Активные чаты
                </div>
                <div id="contacts-list">
                    <!-- Здесь будут контакты -->
                </div>
            </div>
        </div>

        <!-- Правая панель (Chat Window) -->
        <div id="chat-window" class="flex-grow flex flex-col bg-gray-900 hidden">
            <!-- Header -->
            <div id="chat-header" class="p-4 border-b border-gray-700 bg-gray-800 shadow-md">
                <h3 id="chat-title" class="text-xl font-semibold text-white">Выберите чат</h3>
            </div>

            <!-- Messages Area -->
            <div id="messages-area" class="flex-grow overflow-y-auto p-4 space-y-4">
                <div id="no-chat-selected" class="flex items-center justify-center h-full text-gray-500 text-lg">
                    <p>Выберите друга в меню слева или введите его ID, чтобы начать переписку.</p>
                </div>
                <!-- Здесь будут сообщения -->
                <div id="messages-end-ref"></div>
            </div>

            <!-- Input Area -->
            <div id="input-area" class="p-4 border-t border-gray-700 bg-gray-800 hidden">
                <form id="message-form" class="flex space-x-3">
                    <input
                        type="text"
                        id="message-input"
                        placeholder="Введите сообщение..."
                        class="flex-grow p-3 bg-gray-700 text-white rounded-full focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400 border-none outline-none transition duration-150"
                    />
                    <button
                        type="submit"
                        id="send-button"
                        class="bg-blue-600 hover:bg-blue-700 p-3 rounded-full text-white font-semibold shadow-xl transition duration-150 disabled:bg-gray-600 disabled:cursor-not-allowed"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- MAIN JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, onSnapshot, collection, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ И НАСТРОЙКИ ===
        
        // Конфигурация Firebase
        // !!! ВАЖНО: Вы получили ошибку (auth/configuration-not-found). 
        // Это означает, что эти настройки могут быть неверны ИЛИ Анонимная Аутентификация
        // не включена в вашем проекте Firebase (Настройки -> Authentication -> Sign-in method -> Anonymous).
        const VERCEL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAemRqS-QxuehmOvpKfZaUqEvY0vEANH_o", // Проверьте этот ключ в Настройках проекта
            authDomain: "mesengergrok.firebaseapp.com",
            databaseURL: "https://mesengergrok-default-rtdb.firebaseio.com", // НОВАЯ СТРОКА
            projectId: "mesengergrok", // Проверьте этот ID
            storageBucket: "mesengergrok.firebasestorage.app",
            messagingSenderId: "610820074834",
            appId: "1:610820074834:web:49c2279bf53f9338f01e8b",
            measurementId: "G-B0NMTXH6HK" // НОВАЯ СТРОКА
        };

        // Глобальные переменные среды Canvas (если существуют)
        const canvasFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : 'messenger-app-v1';

        // Определяем, какую конфигурацию использовать
        const firebaseConfig = canvasFirebaseConfig || VERCEL_FIREBASE_CONFIG;
        const appId = canvasAppId;

        let db;
        let auth;
        let userId = null;
        let currentChatId = null;
        let currentRecipientId = '';
        let contacts = [];
        let unsubscribeMessages = null; // Для очистки слушателя сообщений

        // === УТИЛИТАРНЫЕ ФУНКЦИИ ===
        
        // Детерминированное создание ID чата
        const getChatId = (u1, u2) => [u1, u2].sort().join('___');

        // Получение DOM-элементов
        const getEl = (id) => document.getElementById(id);

        // Обновление статуса загрузки
        const setLoadingState = (message, showSpinner = true) => {
            getEl('loading-message').textContent = message;
            getEl('loading-spinner').classList.toggle('hidden', !showSpinner);
        };

        // Отображение главной части приложения
        const showApp = () => {
            getEl('loading-screen').classList.add('hidden');
            getEl('sidebar').classList.remove('hidden');
            getEl('chat-window').classList.remove('hidden');
        };
        
        // Визуальное отображение ошибки (вместо alert/console.error)
        const displayChatError = (message) => {
            const errorEl = getEl('chat-error');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            setTimeout(() => {
                errorEl.classList.add('hidden');
            }, 3000);
        };

        // === ИНИЦИАЛИЗАЦИЯ И АВТОРИЗАЦИЯ FIREBASE ===

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Слушатель состояния авторизации
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        getEl('user-id-display').textContent = userId;
                        setLoadingState('Авторизация успешна. Подготовка чата...');
                        
                        // Создание/обновление документа пользователя
                        const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                        await setDoc(userDocRef, { 
                            lastActive: serverTimestamp(),
                            displayName: `Пользователь ${userId.substring(0, 6)}`
                        }, { merge: true });

                        showApp();
                    } else {
                        // Попытка входа
                        setLoadingState('Авторизация...');
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            // !!! ЭТА ОШИБКА: (auth/configuration-not-found) !!! 
                            setLoadingState('Ошибка авторизации. Проверьте настройки Firebase (ключи/включена ли Анонимная Auth).', false);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                setLoadingState('Критическая ошибка Firebase. См. консоль.', false);
            }
        }
        
        // === ЛОГИКА ЧАТА ===

        // Обновление списка контактов в DOM
        const updateContactsList = () => {
            const listEl = getEl('contacts-list');
            listEl.innerHTML = ''; // Очистка
            
            contacts.filter(c => c !== userId).forEach(contact => {
                const chatId = getChatId(userId, contact);
                const isActive = chatId === currentChatId;

                const contactEl = document.createElement('div');
                contactEl.className = `p-3 mx-2 rounded-xl cursor-pointer transition duration-150 ${
                    isActive ? 'bg-blue-600 shadow-lg text-white font-semibold' : 'hover:bg-gray-700 text-gray-300'
                }`;
                contactEl.innerHTML = `
                    <div class="font-medium truncate">
                        <span class="text-sm">Чат с: ${contact.substring(0, 8)}...</span>
                    </div>
                    ${isActive ? '<div class="text-xs opacity-80">Активен</div>' : ''}
                `;
                contactEl.onclick = () => handleSelectChat(contact);
                listEl.appendChild(contactEl);
            });
        };

        // Рендеринг сообщений
        const renderMessages = (messages) => {
            const messagesArea = getEl('messages-area');
            messagesArea.innerHTML = ''; // Очистка
            
            if (!currentChatId) {
                messagesArea.appendChild(getEl('no-chat-selected').cloneNode(true));
                return;
            }

            // Добавление заглушки для прокрутки
            const messagesEndRef = getEl('messages-end-ref');
            messagesArea.appendChild(messagesEndRef);

            messages.forEach(msg => {
                const isMyMessage = msg.senderId === userId;
                const time = msg.timestamp?.toDate ? msg.timestamp.toDate().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'}) : '...';

                const msgContainer = document.createElement('div');
                msgContainer.className = `flex ${isMyMessage ? 'justify-end' : 'justify-start'}`;
                
                msgContainer.innerHTML = `
                    <div class="max-w-xs sm:max-w-md p-3 rounded-2xl shadow-lg relative ${isMyMessage 
                        ? 'bg-blue-600 text-white rounded-br-none' 
                        : 'bg-gray-700 text-white rounded-tl-none'
                    }">
                        <p class="text-sm break-words">${msg.text}</p>
                        <div class="text-xs mt-1 ${isMyMessage ? 'text-blue-200' : 'text-gray-400'} text-right">
                            ${time}
                        </div>
                    </div>
                `;
                messagesArea.insertBefore(msgContainer, messagesEndRef);
            });

            // Прокрутка вниз
            messagesEndRef.scrollIntoView({ behavior: 'smooth' });
        };

        // Запуск слушателя сообщений для выбранного чата
        const startMessageListener = (chatId) => {
            if (unsubscribeMessages) {
                unsubscribeMessages(); // Очистка предыдущего слушателя
            }
            
            getEl('input-area').classList.remove('hidden');
            getEl('no-chat-selected').classList.add('hidden');
            
            setLoadingState('Загрузка сообщений...');

            const chatPath = `artifacts/${appId}/public/data/threads/${chatId}/messages`;
            const messagesRef = collection(db, chatPath);
            const messagesQuery = query(messagesRef, orderBy('timestamp', 'asc'));

            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                const newMessages = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                }));
                renderMessages(newMessages);
                setLoadingState(null, false); // Скрыть загрузку
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                setLoadingState('Ошибка загрузки сообщений. Проверьте правила безопасности.', false);
            });
        };

        // === ОБРАБОТЧИКИ СОБЫТИЙ ===

        const handleSelectChat = (friendId) => {
            if (friendId === userId) return;
            currentRecipientId = friendId;
            currentChatId = getChatId(userId, friendId);
            
            // Добавление контакта (если новый)
            if (!contacts.includes(friendId)) {
                contacts.push(friendId);
            }
            
            updateContactsList();
            getEl('chat-title').textContent = `Чат с: ${friendId.substring(0, 10)}...`;
            startMessageListener(currentChatId);
        };

        const handleStartNewChat = () => {
            const recipientIdInput = getEl('recipient-id-input').value.trim();
            if (!recipientIdInput || recipientIdInput === userId) {
                const errorMessage = recipientIdInput === userId 
                    ? 'Вы не можете начать чат с самим собой.' 
                    : 'Пожалуйста, введите корректный ID друга.';
                displayChatError(errorMessage);
                return;
            }
            handleSelectChat(recipientIdInput);
            getEl('recipient-id-input').value = ''; // Очистка поля ввода
        };

        const handleSendMessage = async (e) => {
            e.preventDefault();
            const messageInput = getEl('message-input');
            const newMessageText = messageInput.value.trim();
            
            if (!newMessageText || !currentChatId || !db) return;

            const chatPath = `artifacts/${appId}/public/data/threads/${currentChatId}/messages`;

            try {
                await addDoc(collection(db, chatPath), {
                    senderId: userId,
                    text: newMessageText,
                    timestamp: serverTimestamp(),
                });
                messageInput.value = ''; // Очистка
            } catch (error) {
                console.error("Error sending message:", error);
                displayChatError('Ошибка отправки сообщения.');
            }
        };

        // === НАСТРОЙКА СЛУШАТЕЛЕЙ DOM ===

        window.onload = () => {
            initializeFirebase();
            
            getEl('start-chat-button').onclick = handleStartNewChat;
            getEl('message-form').onsubmit = handleSendMessage;
        };

    </script>
</body>
</html>
